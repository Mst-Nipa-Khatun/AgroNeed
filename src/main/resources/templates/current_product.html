<!doctype html>
<html layout:decorate="~{shared/layout}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>View All Products</title>
</head>
<body>
<div layout:fragment="content">
    <div class="container mt-4">
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4" th:if="${products != null}">
            <div class="col" th:each="product : ${products}">
                <div class="card h-100 border-0 text-center">
                    <!-- Product Image -->
                    <img th:src="${product.imageUrl}" alt="Product Image"
                         class="card-img-top p-3"
                         style="height: 200px; object-fit: contain;"/>

                    <div class="card-body text-center p-2">
                        <h3 th:text="${product.productName}" class="fw-normal text-dark mb-1"
                            style="min-height: 50px;"></h3>
                        <p th:text="${product.description}" class="text-danger fw-bold fs-5 mb-1"></p>
                        <p th:text="'৳' + ${product.price}" class="text-muted small mb-1"></p>
                        <p th:text="'Stock: ' + ${product.stock}" class="text-muted small"></p>
                    </div>
                    <!-- Add to Bag Button -->
                    <div class="card-footer bg-transparent border-0 px-2 pb-3">
                        <button class="btn w-100 add-to-cart-btn text-danger fw-semibold border" style="background-color: #fff;"
                                th:attr="data-id=${product.productId}">
                            <i class="bi bi-lightning-charge-fill me-1" ></i> Add to Cart
                        </button>
                        <!--SHOW DETAILS BTN-->
                        <button class="btn w-100 product-details-btn text-primary fw-semibold border mt-2" style="background-color: #fff;"
                                th:attr="data-id=${product.productId}">
                            <i class="bi bi-info-circle-fill me-1" ></i> DETAILS
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>

<script>
    $(document).ready(function () {
        $(".product-details-btn").on("click", function () {
            let productId = $(this).data("id");
            let credential = window.getCredential();

            // Fetch product details and comments
            Ajax.get("/api/comments/product/" + productId, null, null, false)
                .then(response => {
                    const comments = (response.statusCode === 200 && response.content) ? response.content : [];

                    // Create Modal HTML dynamically
                    const modalHtml = `
                        <div class="modal fade" id="dynamicProductCommentsModal" tabindex="-1" aria-labelledby="dynamicCommentsLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="dynamicCommentsLabel">Product Comments</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div id="dynamicCommentsContainer">
                                            ${comments.length === 0
                        ? '<p class="text-center text-muted">No comments yet for this product.</p>'
                        : comments.map(comment => `
                                                    <div class="card mb-2">
                                                        <div class="card-body">
                                                            <div class="d-flex align-items-start">
                                                                <img src="/agroNeed.png" class="rounded me-3 border" style="width: 60px; height: 60px; object-fit: cover;" alt="User Avatar">
                                                                <div class="ml-2">
                                                                    <h6 class="mb-1">${comment.user.name}</h6>
                                                                    <p class="mb-1">${comment.comment}</p>
                                                                    <small class="text-muted">${new Date(comment.createdAt).toLocaleString()}</small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                `).join('')
                    }
                                        </div>

                                        <!-- Add Comment Input -->
                                        <div class="mt-3">
                                            <div class="mb-2">
                                                <textarea id="newCommentText" class="form-control" rows="3" placeholder="Write your comment..."></textarea>
                                            </div>
                                            <button id="submitCommentBtn" class="btn btn-primary w-100">
                                                <i class="bi bi-send-fill me-1"></i> Add Comment
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Append modal to body
                    $("body").append(modalHtml);

                    // Show modal
                    const modalElement = document.getElementById('dynamicProductCommentsModal');
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();

                    // Handle comment submission
                    $("#submitCommentBtn").on("click", function() {
                        const commentText = $("#newCommentText").val().trim();

                        if (!commentText) {
                            showWarningToast("Please enter a comment");
                            return;
                        }

                        if (!credential || !credential.content || !credential.content.userId) {
                            showWarningToast("Please login to comment");
                            window.location.href = "/login";
                            return;
                        }

                        const requestBody = {
                            productId: productId,
                            userId: credential.content.userId,
                            comment: commentText
                        };

                        Ajax.post("/api/comments/add", requestBody, null, false)
                            .then(response => {
                                if (response.statusCode === 200) {
                                    $("#newCommentText").val("");

                                    // Create new comment element
                                    const newComment = response.content;
                                    const commentHtml = `
                                        <div class="card mb-2">
                                            <div class="card-body">
                                                <div class="d-flex align-items-start">
                                                    <img src="${newComment.user.profileImage || '/images/default-avatar.png'}" class="rounded me-3 border" style="width: 60px; height: 60px; object-fit: cover;" alt="User Avatar">
                                                    <div>
                                                        <h6 class="mb-1">${newComment.user.name}</h6>
                                                        <p class="mb-1">${newComment.comment}</p>
                                                        <small class="text-muted">${new Date(newComment.createdAt).toLocaleString()}</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;

                                    // Add to comments container
                                    if ($("#dynamicCommentsContainer p.text-muted").length) {
                                        $("#dynamicCommentsContainer").html(commentHtml);
                                    } else {
                                        $("#dynamicCommentsContainer").prepend(commentHtml);
                                    }

                                    showSuccessToast("Comment added successfully");
                                } else {
                                    showWarningToast(response.message || "Failed to add comment");
                                }
                            })
                            .catch(error => {
                                console.error("Error adding comment:", error);
                                showErrorToast("Error adding comment: " + (error.message || "Unknown error"));
                            });
                    });

                    // Remove modal from DOM when hidden
                    modalElement.addEventListener('hidden.bs.modal', function () {
                        modalElement.remove();
                    });
                })
                .catch(error => {
                    console.error("Error fetching comments:", error);
                    showErrorToast("Error fetching comments: " + (error.message || "Unknown error"));
                });
        });

        // Add to Cart functionality (unchanged)
        $(".add-to-cart-btn").on("click", function () {
            let productId = $(this).data("id");
            let quantity = 1;
            let credential = window.getCredential();
            if (!credential || !credential.content || !credential.content.userId) {
                console.warn("User not logged in — redirecting...");
                window.location.href = "/login";
                return;
            }
            let userId = credential.content.userId;
            let requestBody = {
                userId: userId,
                productId: productId,
                quantity: quantity
            };
            Ajax.post("/shoppingCart/create", requestBody, null, true)
                .then(response => {
                    if(response.statusCode===201){
                        //showSuccessToast(response.message);
                        showShoppingCartCount();//For show product count in header icon
                    }else {
                        showWarningToast(response.message);
                    }
                })
                .catch(error => {
                    console.log("Error adding to cart:", error);
                    if (error.status === 401 || error.status === 403) {
                        window.location.href = "/login";
                    } else {
                        showErrorToast("Error: " + error.message);
                    }
                });
        });
    });

    // Shopping cart count functionality (unchanged)
    function showShoppingCartCount() {
        let shoppingCartCountSelection = $(".shoppingCartCount");
        let credential = window.getCredential();
        if (!credential || !credential.content || !credential.content.userId) {
            console.warn("User not logged in — redirecting...");
            shoppingCartCountSelection.text(0);
            return;
        }
        Ajax.get("/shoppingCart/getAll", {userId: credential.content.userId}, null)
            .then(response => {
                console.log(response);
                if (response.content == null) {
                    shoppingCartCountSelection.text(0)
                } else {
                    let activeShoppingCartCount = response.content.length;
                    shoppingCartCountSelection.text(activeShoppingCartCount)
                }
            }).catch(error => {
            shoppingCartCountSelection.text(0)
            console.log(error);
            showErrorToast("Error " + error);
        })
    }
</script>